# Lab-2 Report

## 实现目标

- 实现了物理内存的初始化与基本管理
- 实现了SV39模式的三级页表的创建与管理
- 在系统启动过程中完成了内存管理单元的初始化并启用SV39分页机制
- 编写了物理内存与虚拟内存的测试
- 对部分代码进行了优化和重构

## 具体步骤

### 1. 实现了物理内存的初始化与基本管理
- 实现了基本的结构体和常量，用于管理物理内存的分配与释放
    * `PhysAddr,VirtAddr`: 物理地址与虚拟地址类型定义，作为usize(u64)的别名
    * `FreePage`: 物理页空闲链表项
    * `RegionInner`: 物理内存区域
    * `RegionBounds`: 物理内存区域边界
    * `AllocRegion`: 分配的物理内存区域，包括锁保护的内部区域和边界信息
    * `KERNEL_REGION`: 静态分配的内核物理内存区域
    * `USER_REGION`: 静态分配的用户物理内存区域
- 实现了DTB模块中解析物理内存信息的功能
- 实现了物理内存分配与释放的基本函数
    * `pmem_alloc`: 分配物理内存页
        * 根据请求的类型调用对应的结构体分配函数（内核或用户区域）
        * 获取链表头部，返回分配的物理页地址
        * 清空分配的物理页内容，返回物理页地址
        * 如果没有可用的物理页，panic
    * `pmem_free`: 释放物理内存页
        * 根据地址判断属于哪个区域，调用对应的结构体释放函数
        * 检查地址空间，如果越界则panic
        * 将释放的物理页插入到链表头部
- 实现了物理内存的初始化函数
    * 修改了linker.ld文件，定义内核物理内存区域的边界符号
    * 获取内核物理内存区域的边界地址，解析DTB中的内存信息，计算出可分配的物理内存区域
    * 初始化内核和用户物理内存区域的结构体，内核区域从内核结束地址开始，共4MB，用户区域从4MB开始，到物理内存结束地址
    * 使用call_once确保初始化函数只执行一次
### 2. 实现了SV39模式的三级页表的创建与管理
- 实现了页表项和页表结构体
    * `Pte`: 页表项结构体，包含物理页地址和标志位
    * `PteFlags`: 页表项标志位
    * `PageTable`: 页表结构体，包含页表项数组
- 在linker.ld文件中定义内核页表的边界符号
- 实现了页表的基本操作函数
    * `vm_get_pa`: 根据虚拟地址获取对应的物理地址
        * 计算虚拟地址的三级索引
        * 逐级遍历页表，查找对应的页表项
        * 如果找到叶子页表项，返回物理地址
        * 如果中间层遇到叶子页表项或未找到，返回None
    * `vm_mappages`: 映射虚拟地址到物理地址
        * 计算虚拟地址的三级索引
        * 逐级遍历页表，创建中间层页表项
        * 设置叶子页表项，包含物理地址和标志位
    * `vm_unmappages`: 解除虚拟地址到物理地址的映射
        * 计算虚拟地址的三级索引
        * 逐级遍历页表，查找对应的页表项
        * 清除叶子页表项
        * 如果中间层页表项为空，释放对应的页表
        * 调用pmem_free释放物理页
    * `vm_print`: 打印页表内容，调试用
- 实现了页表的初始化函数
    * 在内核启动过程中调用，初始化内核页表，使用Once确保只初始化一次
        * 读取符号获取位置，对等映射内核代码段、数据段、堆栈段和设备内存区域
        * .text段映射为R-X
        * .rodata段映射为R--
        * .data和.bss段映射为RW-
        * UART设备内存映射为RW-
        * 内核栈映射为RW-
        * 用户空间映射为RW-
    * 在每个核心上，启用SV39分页机制，设置satp寄存器，将页表基地址写入satp，并执行sfence.vma指令刷新TLB
### 3. 编写了物理内存与虚拟内存的测试
- 编写物理内存测试
    * 测试内核物理内存的分配与释放
    * 测试用户物理内存的分配，释放与耗尽测试
- 编写虚拟内存测试
    * 测试虚拟内存的相关函数
    * 测试虚拟地址到物理地址的映射与解除映射是否正确
### 4. 对部分代码进行了优化和重构
- 为多核测试编写了统一的测试框架TEST_BARRIER，确保所有核在测试前后同步
- 添加了trap机制便于排错
- 在测试前关闭分页，测试后开启